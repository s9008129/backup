# Phase 1 改善工程進度清單 (Implementation Checklist)

## 實施進度追蹤

### Phase 1: Critical Issues (必須修復)

#### P1-1: 備份完整性檢查 ✅ 已完成
**目標**: 驗證備份是否與 manifest 一致
**風險降低**: 🔴 CRITICAL → 完全消除
**預期工作量**: 2小時
**進度**:
- [x] 定義 BackupIntegrityError 例外
- [x] 實現 verify_backup_integrity() 方法
- [x] 在備份流程中集成驗證
- [x] 編寫測試用例
- [x] 驗證功能正確 ✅ 所有測試通過
- [ ] 更新文檔

**實現細節**:
- 新增 BackupIntegrityError 異常類
- verify_backup_integrity() 掃描實際備份並比較 manifest
- 如果備份缺失，提醒用戶並選擇重新執行

---

#### P1-2: 源資料夾路徑驗證 ✅ 已完成
**目標**: 防止同步錯誤資料夾
**風險降低**: 🟠 HIGH → 🟢 消除
**預期工作量**: 1.5小時
**進度**:
- [x] 實現源路徑檢查邏輯
- [x] 集成到備份前檢查
- [x] 處理用戶確認邏輯
- [x] 編寫測試
- [x] 驗證功能 ✅ 所有測試通過

**實現細節**:
- manifest.data['sourceFolder'] 與當前 source 比較
- 路徑改變時提示用戶，選擇清除舊紀錄或取消

---

#### P1-3: 空間預檢查 ✅ 已完成
**目標**: 複製前驗證可用空間
**風險降低**: 🟠 HIGH → 🟡 降低到 MEDIUM
**預期工作量**: 1.5小時
**進度**:
- [x] 實現 check_disk_space() 方法
- [x] 集成計算和驗證邏輯
- [x] 在備份流程早期執行
- [x] 編寫測試
- [x] 驗證功能 ✅ 所有測試通過

**實現細節**:
- 計算源資料夾總大小
- 檢查目標磁碟可用空間
- 保留 20% 緩衝區

---

#### P1-4: 原子性 Manifest 更新 ✅ 已完成
**目標**: 防止 manifest 部分寫入
**風險降低**: 🔴 CRITICAL → 完全消除
**預期工作量**: 1小時
**進度**:
- [x] 修改 BackupManifest.save() 使用臨時檔案
- [x] 實現原子性重命名
- [x] 邊界情形測試
- [x] 驗證功能 ✅ 所有測試通過

**實現細節**:
- 使用 tempfile.mkstemp() 建立臨時檔案
- 寫入並驗證 JSON 有效性
- os.replace() 進行原子重命名
- 異常處理和清理

---

## 實施順序

建議順序（依賴性考量）:
1. **P1-4** (原子性更新) - 基礎改善，其他依賴
2. **P1-1** (完整性檢查) - 需要原子性確保 manifest 有效
3. **P1-3** (空間預檢查) - 獨立改善
4. **P1-2** (路徑驗證) - 獨立改善

---

## 代碼審查清單

每個改善完成後進行檢查:

### 第一性原理檢查
- [ ] 改善解決了根本問題嗎？
- [ ] 設計符合「最小變動」原則嗎？
- [ ] 有無副作用或新的盲點？

### COT 推導檢查
- [ ] 邏輯推導完整嗎？
- [ ] 邊界情形都考慮了嗎？
- [ ] 例外處理完善嗎？

### 代碼質量檢查
- [ ] 命名規範一致嗎？
- [ ] 註解清晰嗎？
- [ ] 有無重複代碼？
- [ ] 錯誤訊息有幫助嗎？

### 測試檢查
- [ ] 單元測試通過嗎？
- [ ] 邊界情形測試包括嗎？
- [ ] 異常情況處理測試嗎？

---

## 測試計畫

### 單元測試
```python
def test_verify_backup_integrity():
    """測試完整性檢查"""
    # 測試1: 備份完整
    # 測試2: 備份缺少檔案
    # 測試3: 備份為空
    pass

def test_validate_source_path():
    """測試路徑驗證"""
    # 測試1: 路徑未變
    # 測試2: 路徑改變，用戶確認
    # 測試3: 路徑改變，用戶取消
    pass

def test_check_disk_space():
    """測試空間檢查"""
    # 測試1: 空間充足
    # 測試2: 空間不足
    # 測試3: 邊界情況（恰好 80%）
    pass

def test_manifest_atomic_update():
    """測試原子性更新"""
    # 測試1: 正常更新
    # 測試2: 中途中斷（模擬）
    # 測試3: 驗證舊 manifest 在更新中仍可讀
    pass
```

---

## 集成測試計畫

1. **完整備份流程**
   - 首次備份 → 驗證完整性
   - 修改檔案 → 增量備份 → 驗證完整性
   - 刪除檔案 → 增量備份 → 驗證完整性

2. **異常情況**
   - 空間不足時備份
   - 源路徑改變時備份
   - 並發備份（P2 但先準備測試用例）

3. **邊界情形**
   - 備份為空
   - 檔案被鎖定
   - 硬碟滿（預留空間 < 閾值）

---

## 風險評估

| 改善 | 風險 | 緩解措施 |
|------|------|----------|
| P1-1 | 增加備份時間 | 只在備份開始檢查一次 |
| P1-2 | 中斷用戶工作流 | 只在路徑改變時提示 |
| P1-3 | 計算空間誤差 | 保留 20% 緩衝 |
| P1-4 | 磁碟操作失敗 | 例外處理 + 回滾邏輯 |

---

## 文檔更新計畫

- [ ] spec.md: 新增可靠性章節
- [ ] 操作指南.md: 新增故障診斷部分
- [ ] README.md: 強調可靠性特性
- [ ] copilot-instructions.md: 更新設計原則

---

## 提交計畫

每個改善單獨 commit:
1. `feat: P1-4 實現原子性 manifest 更新`
2. `feat: P1-1 新增備份完整性檢查`
3. `feat: P1-3 新增磁碟空間預檢查`
4. `feat: P1-2 新增源路徑驗證機制`
5. `docs: 更新文檔以反映可靠性改善`

每個 commit 包含:
- 功能實現
- 單元測試
- 詳細的中文 log

---

**開始日期**: 2026-01-30  
**預期完成**: 2026-01-30  
**狀態**: 待開始 ⏳

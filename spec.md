# 功能規格：簡易差異備份工具（Simple Delta Backup Tool）

**功能分支**: `main`  
**建立日期**: 2026-01-30  
**狀態**: 發布（v1.0 完整版）  
**輸入**: 本地檔案系統 + 外接式儲存裝置  

> **專案定位**：簡易差異備份工具是一個「Windows 專用的自動化檔案備份系統」，使用智能差異檢測只備份新增/修改的檔案，實現高效、可靠的增量備份。具有簡潔友善的 GUI 介面、詳細的日誌記錄、以及 1 年保留政策的自動清理機制。無需複雜配置、無需加密、無需網路連線。

---

## Clarifications

### Session 2026-01-30

- Q: 為什麼採用差異檢測而非完整備份？ → A: 大幅提升備份速度，第一次完整備份，之後只複製異動檔案，節省時間和儲存空間
- Q: 系統如何判定檔案已修改？ → A: 比較檔案大小和修改時間戳記，任一項不同即視為修改，簡單可靠
- Q: 備份中止後如何恢復？ → A: 通過 .backup_manifest 記錄上次備份狀態，下次備份時檢測已複製檔案，避免重複
- Q: 已刪除的檔案如何處理？ → A: 檢測到刪除但不在備份中刪除（保護策略），用戶可手動清理或設定 1 年保留政策自動清理
- Q: 為什麼不使用加密？ → A: 用戶需求優先，簡潔設計優先。加密增加複雜度，當前使用者不需要
- Q: GUI 為什麼設計成單頁無滾動？ → A: 非技術人員可一目瞭然看到所有功能和訊息，降低使用障礙

---

## 使用者情境與測試 *(必要)*

### User Story 1 - 首次完整備份（Priority: P1）

作為一位有重要檔案需要保護的 Windows 使用者，我希望只需選擇一個來源資料夾和外接式儲存裝置上的目的資料夾，系統就能自動複製所有檔案，並記錄備份時間和檔案清單，這樣我就能安心知道檔案已被妥善保護。

**為什麼此優先級**：這是系統的核心價值主張。首次備份是所有後續增量備份的基礎，必須完整可靠。

**獨立測試**：選擇一個包含 100+ 檔案的來源資料夾，執行首次備份，驗證所有檔案都被複製到目的地，且大小完全相同。

**驗收情境**：

1. **Given** 使用者有一個未備份過的來源資料夾，**When** 選擇來源和目的地後點擊「開始備份」，**Then** 系統掃描所有檔案並開始複製
2. **Given** 備份進行中，**When** 進度條顯示，**Then** 使用者可看到當前進度百分比、已複製檔案數、總檔案數
3. **Given** 複製完成，**When** 系統驗證大小一致，**Then** 所有檔案都被正確複製，未有任何大小不符
4. **Given** 備份完成，**When** 查看歷史記錄，**Then** 記錄顯示備份時間、複製檔案數、總大小、持續時間

---

### User Story 2 - 增量差異備份（Priority: P1）

作為一位定期編輯檔案的使用者，我希望第二次執行備份時，系統只複製新增和修改過的檔案，而不是重新複製全部，這樣備份速度會快很多，我可以更頻繁地進行備份。

**為什麼此優先級**：增量備份是高頻使用情境。無此功能，每次備份都需重新複製全部，極其低效。

**獨立測試**：執行首次備份，然後修改 10 個檔案、新增 5 個檔案，再次執行備份，驗證系統只複製 15 個異動檔案。

**驗收情境**：

1. **Given** 使用者已執行過首次備份，**When** 編輯源資料夾中的檔案（修改 10 個、新增 5 個），**Then** 系統檢測到異動
2. **Given** 再次執行備份，**When** 系統讀取 .backup_manifest 的上次紀錄，**Then** 自動與新掃描結果比較，識別新增/修改檔案
3. **Given** 異動檢測完成，**When** 開始複製，**Then** 只複製 15 個異動檔案，跳過 85 個未改動的檔案
4. **Given** 增量備份完成，**When** 查看歷史記錄，**Then** 記錄顯示「新增 5 個，修改 10 個，未改動 85 個」

---

### User Story 3 - 檔案恢復（Priority: P2）

作為一位意外刪除或損毀重要檔案的使用者，我希望能從備份中恢復檔案，系統應該列出備份中的所有檔案，我可以勾選需要恢復的檔案，系統會將它們複製回來。

**為什麼此優先級**：檔案恢復是備份的終極目的，使用頻率較低但極為重要。

**獨立測試**：從備份中恢復部分檔案到不同目的地，驗證恢復的檔案內容完全相同。

**驗收情境**：

1. **Given** 使用者需要恢復檔案，**When** 點擊「恢復」標籤，**Then** UI 切換到恢復模式
2. **Given** 在恢復模式下，**When** 選擇備份來源資料夾，**Then** 系統列出該備份中的所有檔案（目錄結構完整顯示）
3. **Given** 檔案列表已顯示，**When** 使用者勾選要恢復的檔案，**Then** 可選擇單個、多個或全部恢復
4. **Given** 選擇完成，**When** 點擊「恢復」按鈕並選擇恢復目的地，**Then** 系統複製選定的檔案，保留目錄結構

---

### User Story 4 - 備份日誌和歷史查看（Priority: P2）

作為一位需要了解備份狀況的使用者，我希望系統記錄每次備份的詳細信息，包括備份時間、新增/修改/未改動檔案數、總大小、持續時間、以及任何錯誤訊息，這樣我可以驗證備份是否成功。

**為什麼此優先級**：透明性和可審計性是系統的核心設計原則。詳細日誌幫助使用者建立信心並故障排查。

**獨立測試**：執行備份後檢查 history.json，驗證記錄內容完整準確。

**驗收情境**：

1. **Given** 備份完成，**When** 系統記錄，**Then** 每次備份都生成一筆詳細記錄
2. **Given** 記錄已生成，**When** 查看 history.json，**Then** 包含：備份時間、狀態、新增數、修改數、刪除檢測、總大小、耗時、錯誤列表
3. **Given** 備份中發生錯誤，**When** 系統記錄，**Then** 錯誤訊息清晰記錄，包含出問題的檔案路徑和原因
4. **Given** 使用者查看 GUI 中的歷史面板，**When** 點擊歷史記錄，**Then** 顯示詳細信息

---

### User Story 5 - GUI 單頁設計（Priority: P1）

作為一位非技術人員，我希望 GUI 介面簡潔友善，所有功能和訊息都在一個畫面上，不需要滾動，我可以一目瞭然看到備份進度、歷史記錄、控制按鈕等。

**為什麼此優先級**：易用性決定系統的採用率。非技術人員需要直觀的介面。

**獨立測試**：啟動應用，驗證視窗大小固定且所有內容可見，無需上下滾動。

**驗收情境**：

1. **Given** 使用者啟動應用，**When** GUI 視窗開啟，**Then** 視窗大小固定，所有功能區域一目瞭然
2. **Given** GUI 正在使用，**When** 執行任何操作，**Then** 無需滾動條，所有訊息都在畫面內
3. **Given** 備份進行中，**When** 進度更新，**Then** 進度條、百分比、時間訊息實時顯示在同一頁面
4. **Given** 備份完成，**When** 結果顯示，**Then** 完成訊息、統計摘要在同一頁面顯示

---

### 邊緣案例

- **子資料夾包含檔案**：系統需遞迴掃描，os.walk() 確保找到所有嵌套檔案
- **檔案被鎖定（被其他程序占用）**：顯示警告，自動跳過，繼續備份其他檔案
- **目的地空間不足**：備份前檢查磁碟空間，若不足提示使用者
- **備份中途中斷（程序崩潰、關閉）**：下次備份時通過 .backup_manifest 檢測上次進度，避免重複複製
- **相同路徑的檔案修改時間戳記無變化但內容改變**：使用大小檢測作為額外判斷（尺寸不同 = 已修改）
- **檔案名稱含特殊字符（如中文、符號）**：Windows 原生支援 UTF-8，應用正確處理
- **來源和目的地相同**：檢測並提示使用者，防止自我覆蓋
- **備份中出現磁碟錯誤**：記錄錯誤，提示使用者，允許重試或繼續
- **超大檔案（>1GB）**：系統支援，無特殊限制，進度條顯示精確進度
- **1 年保留政策：自動清理超過 1 年的備份**：當存在已清理標記時，刪除其備份副本

---

## 需求 *(必要)*

### 功能需求

#### 核心功能

- **FR-001**: 系統 MUST 支援遞迴掃描來源資料夾中的所有檔案（所有副檔名）
- **FR-002**: 系統 MUST 能通過比較檔案大小和修改時間戳記檢測新增和修改的檔案
- **FR-003**: 系統 MUST 能通過讀取 .backup_manifest 檢測已備份狀態，實現增量備份
- **FR-004**: 系統 MUST 能複製檔案並驗證大小一致（bit-exact verification）
- **FR-005**: 系統 MUST 支援來源和目的地的完整路徑指定（任意位置的外接裝置）
- **FR-006**: 系統 MUST 在複製前檢查目的地磁碟空間是否足夠
- **FR-007**: 系統 MUST 能實時監控執行進度（進度條、百分比、已複製/總檔案數、預計時間）
- **FR-008**: 系統 MUST 能記錄每次備份的詳細信息到 history.json
- **FR-009**: 系統 MUST 能支援檔案恢復（從備份中選擇檔案恢復到指定位置）
- **FR-010**: 系統 MUST 能正確處理檔案權限錯誤和被鎖定的檔案（跳過並記錄）
- **FR-011**: 系統 MUST 提供簡潔友善的 GUI 介面（tkinter，單頁設計，無需滾動）
- **FR-012**: 系統 MUST 支援備份標籤和恢復標籤的切換
- **FR-013**: 系統 MUST 能讀取和保存設定（上次使用的來源和目的地）
- **FR-014**: 系統 MUST 能支援 1 年保留政策（自動識別和清理超期備份）
- **FR-015**: 系統 MUST 能正確處理和儲存繁體中文檔案名和訊息

#### 備份邏輯

- **FR-016**: 首次備份時 MUST 複製所有檔案，構建完整的 .backup_manifest
- **FR-017**: 增量備份時 MUST 只複製新增和修改的檔案，跳過未改動的檔案
- **FR-018**: 系統 MUST 檢測已刪除的檔案但不在備份中刪除（保留策略）
- **FR-019**: 系統 MUST 在備份中斷後支援恢復（下次備份時檢測已複製檔案）
- **FR-020**: 系統 MUST 記錄每次備份的 added/modified/unchanged/deleted 檔案統計

#### 日誌和追蹤

- **FR-021**: .backup_manifest 應記錄：lastBackupTime, sourceFolder, targetFolder, filesCount, totalSize, filesList
- **FR-022**: history.json 應記錄：backupTime, status, filesAdded, filesModified, filesDeleted, totalSize, duration, errors
- **FR-023**: 系統 MUST 使用 ISO 8601 格式儲存所有時間戳記
- **FR-024**: 系統 MUST 能讀取日誌並顯示最近備份的摘要

#### 錯誤處理

- **FR-025**: 系統 MUST 捕捉檔案操作異常（權限錯誤、檔案鎖定、磁碟錯誤）
- **FR-026**: 系統 MUST 對錯誤檔案顯示警告但繼續備份其他檔案
- **FR-027**: 系統 MUST 在磁碟空間不足時提前提示
- **FR-028**: 系統 MUST 記錄詳細的錯誤訊息供故障排查

#### 效能和可靠性

- **FR-029**: 系統 MUST 支援備份大型檔案（無上限，通過流式複製）
- **FR-030**: 系統 MUST 支援備份大數量檔案（測試於 1000+ 檔案）
- **FR-031**: 系統 MUST 使用 threading 避免 GUI 凍結
- **FR-032**: 系統 MUST 保證檔案複製的原子性（驗證成功才更新 manifest）

### 關鍵實體

- **FileInfo（檔案資訊）**：代表一個檔案，包含相對路徑、大小、修改時間
- **BackupRecord（備份記錄）**：代表一次備份，包含時間、狀態、統計信息、錯誤列表
- **BackupManifest（備份清單）**：代表備份元資料，包含 lastBackupTime、sourceFolder、targetFolder、filesList
- **ChangeDetection（變更檢測）**：代表一次掃描的結果，包含 added、modified、deleted 三個集合
- **Progress（進度）**：代表當前進度狀態，包含 current/total、percentage、eta、status

---

## 架構 *(必要)*

### 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│           用戶介面層 (UI Layer)                          │
│  ┌──────────────────────────────────────────┐          │
│  │     BackupToolGUI (tkinter)              │          │
│  │  • 單頁無滾動設計                        │          │
│  │  • 來源/目的地選擇                       │          │
│  │  • 進度顯示和控制                        │          │
│  │  • 歷史記錄查看                          │          │
│  │  • 恢復標籤和備份標籤                    │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│      備份引擎層 (Backup Engine)                         │
│   src/backup_tool.py - DeltaBackupEngine             │
├─────────────────────────────────────────────────────────┤
│ 1️⃣掃描: 遞迴掃描來源資料夾 → 檔案清單                 │
│    └─ 方法：scan_folder()                            │
│ 2️⃣檢測: 讀取 manifest → 與新掃描比較 → 識別變更      │
│    └─ 方法：detect_changes()                         │
│ 3️⃣複製: 複製 added 和 modified 檔案                  │
│    └─ 方法：copy_file()、verify_backup()            │
│ 4️⃣驗證: 驗證複製的檔案大小是否一致                  │
│    └─ 方法：verify_backup()                         │
│ 5️⃣更新: 更新 .backup_manifest 和 history.json      │
│    └─ 方法：BackupManifest.update()                │
│ 6️⃣報告: 生成備份完成訊息和統計                       │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│    元資料管理層 (Metadata Layer)                        │
│  ┌──────────────────┐   ┌──────────────────┐          │
│  │ BackupManifest   │   │  BackupLogger    │          │
│  │ (manifest.json)  │   │ (history.json)   │          │
│  │ • 上次備份時間   │   │ • 備份歷史紀錄   │          │
│  │ • 檔案清單       │   │ • 統計摘要       │          │
│  │ • 上次備份狀態   │   │ • 錯誤記錄       │          │
│  └──────────────────┘   └──────────────────┘          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│      儲存層 (Storage Layer)                            │
│  ┌──────────────────────────────────────────┐          │
│  │  ~/.backup_tool/                         │          │
│  │  ├── manifest.json   (備份元資料)        │          │
│  │  └── history.json    (備份歷史)          │          │
│  │                                         │          │
│  │  [外接裝置]/[目的資料夾]/                │          │
│  │  ├── 備份的所有檔案                      │          │
│  │  └── .backup_manifest (單位備份元資料)  │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
```

### 執行流程（詳細狀態機）

#### 備份流程

```
[用戶啟動應用]
  ↓
┌─────────────────────────────────┐
│ Phase 1: 初始化                 │
│ • 載入上次設定                  │
│ • 初始化 GUI                    │
│ • 載入 manifest 和 history      │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 2: 用戶操作               │
│ • 選擇來源資料夾                │
│ • 選擇目的資料夾                │
│ • 點擊「開始備份」              │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 3: 掃描 (Scanning)        │
│ • os.walk() 遞迴掃描來源        │
│ → current_files = {path: info}  │
│ • GUI 進度：「掃描中...」       │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 4: 載入上次備份狀態       │
│ • 讀取 .backup_manifest         │
│ → old_files = manifest.files    │
│ • 檢查磁碟空間                  │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 5: 檢測變更 (Detection)   │
│ • detect_changes(old, current)  │
│ → added, modified, deleted      │
│ • GUI 進度：「檢測中...」       │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 6: 複製 (Copying)         │
│ • for each added/modified:      │
│   - copy_file(src, dst)         │
│   - verify size match           │
│ • GUI 進度條更新                │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 7: 驗證 (Verification)    │
│ • verify_backup()               │
│ • 檢查複製的檔案大小完全一致    │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 8: 更新元資料             │
│ • 更新 .backup_manifest         │
│ • 記錄 history.json 項目        │
│ • 儲存設定                      │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 9: 顯示結果               │
│ • GUI 顯示完成訊息              │
│ • 統計摘要：新增/修改/未改動數  │
│ • 顯示耗時                      │
└─────────────────────────────────┘
[結束]
```

#### 恢復流程

```
[用戶點擊「恢復」標籤]
  ↓
┌─────────────────────────────────┐
│ Phase 1: 選擇備份來源           │
│ • 使用者選擇備份資料夾          │
│ • 系統讀取該資料夾中的檔案      │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 2: 顯示檔案列表           │
│ • 列出備份中的所有檔案          │
│ • 顯示目錄結構                  │
│ • 支援勾選單個或多個            │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 3: 使用者選擇             │
│ • 勾選要恢復的檔案              │
│ • 或選擇「全部恢復」            │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 4: 選擇恢復目的地         │
│ • 使用者選擇恢復的目的資料夾    │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 5: 複製恢復               │
│ • 複製選定的檔案到目的地        │
│ • 保留原有的目錄結構            │
│ • 進度條顯示恢復進度            │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ Phase 6: 驗證和完成             │
│ • 驗證複製的檔案                │
│ • 顯示恢復摘要                  │
│ • 記錄到 history.json           │
└─────────────────────────────────┘
[結束]
```

### 程式設計高階邏輯

#### 1. 差異檢測算法

```python
def detect_changes(old_files, new_files):
    """
    核心邏輯：比較新舊檔案狀態
    
    input:
      old_files = {path: {size, modified_time}, ...}
      new_files = {path: {size, modified_time}, ...}
    
    output:
      added = {path: info}        # 新檔案
      modified = {path: info}     # 大小或時間改變
      deleted = {path: info}      # 舊有但現在不存在
    
    邏輯：
    1. 遍歷 new_files，找 added 和 modified
    2. 遍歷 old_files，找 deleted
    3. modified 判斷：size 不同 OR modified_time 不同
    
    優勢：
    • 簡單可靠
    • 無需計算檔案哈希（性能優）
    • 適合 Windows FAT32/NTFS 文件系統
    """
```

#### 2. 增量備份策略

```
首次備份：
  manifest 為空
  → 複製所有檔案
  → 構建完整 manifest
  → 備份完成

增量備份：
  讀取 manifest
  → 掃描當前狀態
  → 比較：added/modified/deleted
  → 只複製 added/modified
  → 更新 manifest
  → 備份完成

關鍵：manifest 是狀態記錄，持久化在備份目的地
```

#### 3. 磁碟空間檢查

```
流程：
1. 計算需複製的總大小 = added + modified 的大小總和
2. 取得目的地的可用空間
3. if needed_size > available_space:
   - 提示使用者空間不足
   - 建議清理或更換裝置
   - 中止備份
4. 備份開始
```

#### 4. 錯誤恢復機制

```
設計原則：容錯性設計

• 檔案被鎖定（使用中）
  → 跳過該檔案
  → 記錄錯誤
  → 繼續備份其他檔案
  
• 權限不足
  → 顯示警告
  → 記錄失敗檔案
  → 下次備份時重試
  
• 磁碟寫入錯誤
  → 驗證失敗
  → 標記檔案為失敗
  → 記錄詳細錯誤

• 備份中斷（應用崩潰）
  → 下次備份時重新掃描
  → 檢測已複製的檔案（大小驗證）
  → 避免重複複製
  → 增量備份感知 + 恢復
```

---

## 資料模型

### FileInfo（檔案資訊）

```python
FileInfo = {
    'path': str,           # 相對於來源資料夾的路徑
    'size': int,           # 檔案大小（位元組）
    'modified': str        # 修改時間戳記（ISO 8601 格式）
}

# 範例
{
    'path': 'Documents/report.pdf',
    'size': 2097152,
    'modified': '2026-01-30T10:20:30.000000'
}
```

### BackupManifest（備份清單）

```json
{
    "lastBackupTime": "2026-01-30T14:30:45.123456",
    "sourceFolder": "C:\\Users\\user\\Documents",
    "targetFolder": "D:\\Backup\\Documents",
    "filesCount": 1234,
    "totalSize": 5368709120,
    "filesList": [
        {
            "path": "reports/2026/january.pdf",
            "size": 2097152,
            "modified": "2026-01-30T10:20:30.000000"
        },
        ...
    ]
}
```

### BackupRecord（備份記錄）

```json
{
    "backupTime": "2026-01-30T14:30:45.123456",
    "status": "success",
    "filesAdded": 45,
    "filesModified": 12,
    "filesDeleted": 0,
    "totalSize": 536870912,
    "duration": 120,
    "errors": []
}

// 狀態值: "success", "warning", "failed"
// errors 例如: ["無法讀取 file1.txt (權限不足)", "無法複製 file2.doc (檔案鎖定)"]
```

### ChangeDetection（變更檢測結果）

```python
ChangeDetection = {
    'added': {path: FileInfo},      # 新增檔案
    'modified': {path: FileInfo},   # 修改檔案
    'deleted': {path: FileInfo}     # 已刪除檔案（備份中保留）
}
```

---

## 使用者情境補充

### US1 完整備份範例

```
來源: C:\Users\john\Documents
目的: D:\Backup\Documents

步驟：
1. 使用者選擇 C:\Users\john\Documents
2. 使用者選擇 D:\Backup\Documents（外接裝置）
3. 點擊「開始備份」
4. 系統掃描 1500 個檔案
5. manifest 為空（首次）→ 全部複製
6. 進度條：0% → 100%
7. 驗證大小一致
8. 更新 manifest
9. 顯示：「✅ 備份完成，複製 1500 個檔案，總大小 5.5 GB，耗時 15 分鐘」
10. 記錄到 history.json

下次備份：
1. 使用者編輯 20 個檔案，新增 10 個
2. 再次點擊「開始備份」
3. 系統掃描 1530 個檔案
4. 讀取上次 manifest
5. 比較：added=10, modified=20, unchanged=1500
6. 只複製 30 個檔案
7. 更新 manifest
8. 顯示：「✅ 備份完成，新增 10 個，修改 20 個，共 30 個，耗時 2 分鐘」
```

### US3 恢復範例

```
意外刪除的檔案: C:\Users\john\Documents\important.xlsx

恢復步驟：
1. 執行應用
2. 點擊「恢復」標籤
3. 選擇備份來源 D:\Backup\Documents
4. 系統列出所有檔案（目錄樹狀結構）
5. 勾選 important.xlsx
6. 點擊「恢復」
7. 選擇恢復目的地 C:\Users\john\Restored
8. 系統複製並驗證
9. 顯示：「✅ 恢復完成，已恢復 1 個檔案」
10. 使用者可在 C:\Users\john\Restored 找到 important.xlsx
```

---

## 驗收準則

### 功能驗收

| 功能 | 驗收準則 | 狀態 |
|------|--------|------|
| 掃描 | 遞迴掃描源資料夾，正確取得所有檔案路徑、大小、修改時間 | ✅ |
| 差異檢測 | 準確識別新增、修改、未改動、已刪除的檔案 | ✅ |
| 增量備份 | 第一次複製所有，後續只複製新增/修改的檔案 | ✅ |
| 檔案複製 | 複製後驗證大小完全一致（byte-exact） | ✅ |
| 元資料管理 | .backup_manifest 正確更新和持久化 | ✅ |
| 日誌記錄 | history.json 記錄每次備份的詳細信息 | ✅ |
| 檔案恢復 | 可恢復任意備份的檔案到指定位置 | ✅ |
| 錯誤處理 | 檔案被鎖定時跳過並記錄，應用繼續運行 | ✅ |
| GUI 介面 | 單頁設計，所有內容無需滾動可見 | ✅ |
| 繁體中文 | 正確顯示和儲存繁體中文檔名和訊息 | ✅ |

### 性能要求

| 場景 | 要求 | 實際 |
|------|------|------|
| 備份 1000 個檔案（~1 GB） | < 5 分鐘 | ✅ |
| 增量備份 10% 檔案（~100 MB） | < 1 分鐘 | ✅ |
| 恢復 100 個檔案 | < 2 分鐘 | ✅ |
| GUI 響應時間 | < 500 ms | ✅ |

### 穩定性要求

- [x] 備份中斷後下次可自動檢測並恢復進度
- [x] 檔案被鎖定時顯示警告並跳過
- [x] 目的地空間不足時提前提示
- [x] 所有異常都有詳細錯誤訊息記錄

---

## 環境需求

### 系統要求

| 項目 | 要求 |
|------|------|
| 作業系統 | Windows 11（或 Windows 10） |
| Python | 3.11+ |
| 記憶體 | 最少 256 MB（建議 512 MB） |
| 磁碟空間 | 50 MB（應用）+ 備份大小 |
| 外接裝置 | USB 3.0+ 外接硬碟或隨身碟 |

### 依賴套件

| 套件 | 版本 | 說明 |
|------|------|------|
| tkinter | 內建 | GUI 框架 |
| json | 內建 | 元資料儲存 |
| shutil | 內建 | 檔案複製 |
| pathlib | 內建 | 路徑處理 |
| datetime | 內建 | 時間戳記 |
| threading | 內建 | 背景執行 |
| os | 內建 | 檔案系統操作 |

### 開發環境

```
Conda 虛擬環境: backup
Python: 3.11
主程序: src/backup_tool.py
測試: tests/test_backup.py
配置: environment.yml, requirements.txt
```

---

## 部署檢查清單

使用此清單重建專案：

- [ ] 1. 安裝 Python 3.11+
- [ ] 2. 建立 Conda 虛擬環境（名稱：backup）
- [ ] 3. 激活環境：`conda activate backup`
- [ ] 4. 安裝依賴：`pip install -r requirements.txt`
- [ ] 5. 執行測試：`python tests/test_backup.py`
- [ ] 6. 執行應用：`python src/backup_tool.py`
- [ ] 7. 測試首次備份（備份 100+ 檔案到外接裝置）
- [ ] 8. 驗證增量備份（修改 10 個檔案後再備份）
- [ ] 9. 驗證檔案恢復（從備份恢復部分檔案）
- [ ] 10. 查看日誌（驗證 history.json 記錄完整）

---

## 系統架構和程式設計高階邏輯

### 層次設計

**用戶介面層 (UI Layer)**
- 責任：提供簡潔友善的 GUI
- 實現：tkinter，單頁無滾動設計
- 特點：二標籤設計（備份/恢復），實時進度顯示

**備份引擎層 (Engine Layer)**
- 責任：核心備份邏輯
- 實現：DeltaBackupEngine 類，包含掃描、檢測、複製、驗證
- 特點：差異檢測算法，增量備份支援

**元資料管理層 (Metadata Layer)**
- 責任：管理備份狀態和歷史
- 實現：BackupManifest 和 BackupLogger 類
- 特點：持久化儲存，JSON 格式

**儲存層 (Storage Layer)**
- 責任：檔案和資料持久化
- 實現：本地檔案系統
- 特點：~/.backup_tool/ 保存應用資料，外接裝置保存備份

### 關鍵設計決策

**1. 差異檢測基於大小和時間，而非哈希**
- 原因：性能優，無需遍歷全部檔案內容
- 適用：Windows FAT32/NTFS，檔案修改時時間戳記準確
- 邊界情況：修改時間戳記相同但內容改變 → 大小檢測補充

**2. 增量備份通過持久化 manifest 實現**
- 原因：簡單可靠，狀態在目的地保存
- 優勢：備份中斷後可恢復，無需本地狀態同步

**3. 單頁 GUI 設計（無滾動）**
- 原因：非技術人員可一目瞭然看到所有功能和進度
- 權衡：視窗大小固定（650x750），犧牲彈性換取可用性

**4. 錯誤採用跳過策略而非中止**
- 原因：容錯性設計，備份繼續執行
- 應用：檔案鎖定、權限不足時跳過並記錄

**5. 1 年保留政策通過標記而非自動刪除**
- 原因：保護性設計，避免意外刪除
- 應用：標記超期備份，允許手動確認後清理

---

**版本**: v1.0  
**完成度**: 100%  
**最後審查**: 2026-01-30  
**目標達成**: 持有此文件可在任何環境完全重建此專案。

此規格文件是專案的單一真理來源（Single Source of Truth），所有開發、測試、部署都應基於本文件進行。
